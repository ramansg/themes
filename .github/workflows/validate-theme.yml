name: Validate Theme

on:
  pull_request_target:
    paths:
      - 'index.json'
  workflow_dispatch:
    inputs:
      theme:
        description: 'Theme repo to validate (e.g. username/theme-name)'
        required: true
        type: string

jobs:
  validate-pr:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Format index.json
        id: format
        run: |
          jq -S . index.json > tmp.json && mv tmp.json index.json
          if git diff --quiet index.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate App Token for commits
        id: app-token-commit
        if: steps.format.outputs.changed == 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Commit formatting
        if: steps.format.outputs.changed == 'true'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.app-token-commit.outputs.token }}
        run: |
          git config user.name "better-lyrics-harmonizer[bot]"
          git config user.email "2418247+better-lyrics-harmonizer[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.event.pull_request.head.repo.full_name }}.git"
          git add index.json
          git commit -m "chore: format index.json"
          git push

      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get new themes
        id: new-themes
        run: |
          if [ -f base/index.json ] && jq empty base/index.json 2>/dev/null; then
            jq -r '.themes[].repo' base/index.json | sort > old_themes.txt
          else
            touch old_themes.txt
          fi
          jq -r '.themes[].repo' index.json | sort > new_themes.txt
          NEW_THEMES=$(comm -13 old_themes.txt new_themes.txt)
          REMOVED_THEMES=$(comm -23 old_themes.txt new_themes.txt)
          echo "themes<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "removed<<EOF" >> $GITHUB_OUTPUT
          echo "$REMOVED_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Clean up removed themes
        id: cleanup
        if: steps.new-themes.outputs.removed != ''
        run: |
          REMOVED_THEMES=""

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Removing: $repo"

            # Find theme ID from lockfile
            if [ -f index.lock.json ]; then
              THEME_ID=$(jq -r --arg repo "$repo" '.themes[] | select(.repo == $repo) | .id' index.lock.json)

              if [ -n "$THEME_ID" ] && [ "$THEME_ID" != "null" ]; then
                # Remove vendored files
                if [ -d "themes/$THEME_ID" ]; then
                  rm -rf "themes/$THEME_ID"
                  echo "Removed themes/$THEME_ID"
                fi

                # Remove from lockfile
                jq --arg repo "$repo" '.themes = [.themes[] | select(.repo != $repo)]' index.lock.json > tmp.json && mv tmp.json index.lock.json

                REMOVED_THEMES="$REMOVED_THEMES$THEME_ID\n"
              fi
            fi
          done <<< "${{ steps.new-themes.outputs.removed }}"

          echo "removed<<EOF" >> $GITHUB_OUTPUT
          echo -e "$REMOVED_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Collect existing theme IDs from lockfile
        id: existing-ids
        run: |
          EXISTING_IDS=""
          if [ -f base/index.lock.json ] && jq empty base/index.lock.json 2>/dev/null; then
            EXISTING_IDS=$(jq -r '.themes[].id' base/index.lock.json | tr '\n' '\n')
          fi
          echo "ids<<EOF" >> $GITHUB_OUTPUT
          echo "$EXISTING_IDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for duplicate theme IDs
        id: check-duplicates
        if: steps.new-themes.outputs.themes != ''
        run: |
          RESULTS=""
          HAS_ERRORS=false
          EXISTING_IDS="${{ steps.existing-ids.outputs.ids }}"

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Checking for duplicate ID: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null

            if [ ! -d "theme-repo" ]; then
              RESULTS="$RESULTS\n### $repo\nFailed to clone repository\n"
              HAS_ERRORS=true
              continue
            fi

            if [ -f "theme-repo/metadata.json" ]; then
              THEME_ID=$(jq -r '.id // empty' theme-repo/metadata.json)
              if [ -n "$THEME_ID" ] && echo -e "$EXISTING_IDS" | grep -qx "$THEME_ID"; then
                RESULTS="$RESULTS\n### $repo\n**Error: Duplicate theme ID** - \`$THEME_ID\` already exists in another theme.\n"
                HAS_ERRORS=true
              fi
            fi

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT

      - name: Validate themes
        id: validate
        if: steps.new-themes.outputs.themes != '' && steps.check-duplicates.outputs.has_errors != 'true'
        run: |
          RESULTS=""
          HAS_ERRORS=false

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Validating: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null

            if [ ! -d "theme-repo" ]; then
              RESULTS="$RESULTS\n### $repo\nFailed to clone repository\n"
              HAS_ERRORS=true
              continue
            fi

            OUTPUT=$(NO_COLOR=1 npx create-bl-theme@latest validate theme-repo 2>&1 | sed 's/\x1b\[[0-9;]*m//g') || HAS_ERRORS=true
            RESULTS="$RESULTS\n### $repo\n\`\`\`\n$OUTPUT\n\`\`\`\n"

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT

      - name: Vendor new themes
        id: vendor
        if: steps.new-themes.outputs.themes != '' && steps.check-duplicates.outputs.has_errors != 'true' && steps.validate.outputs.has_errors != 'true'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VENDORED_THEMES=""

          # Initialize lockfile if it doesn't exist
          if [ ! -f index.lock.json ]; then
            echo '{"version":1,"updated":"'"$TIMESTAMP"'","themes":[]}' > index.lock.json
          fi

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Vendoring: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null
            if [ ! -d "theme-repo" ]; then
              echo "Failed to clone $repo"
              continue
            fi

            cd theme-repo
            COMMIT=$(git rev-parse HEAD)
            cd ..

            THEME_ID=$(jq -r '.id' theme-repo/metadata.json)
            VERSION=$(jq -r '.version' theme-repo/metadata.json)

            # Create vendor directory
            mkdir -p "themes/$THEME_ID"

            # Copy essential files
            cp theme-repo/metadata.json "themes/$THEME_ID/"
            [ -f theme-repo/style.rics ] && cp theme-repo/style.rics "themes/$THEME_ID/"
            [ -f theme-repo/style.css ] && cp theme-repo/style.css "themes/$THEME_ID/"
            [ -f theme-repo/shader.json ] && cp theme-repo/shader.json "themes/$THEME_ID/"
            [ -f theme-repo/DESCRIPTION.md ] && cp theme-repo/DESCRIPTION.md "themes/$THEME_ID/"
            [ -f theme-repo/cover.png ] && cp theme-repo/cover.png "themes/$THEME_ID/"
            [ -d theme-repo/images ] && cp -r theme-repo/images "themes/$THEME_ID/"

            # Calculate integrity hash
            INTEGRITY=$(find "themes/$THEME_ID" -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)

            # Update or add to lockfile (upsert by repo)
            jq --arg repo "$repo" --arg id "$THEME_ID" --arg v "$VERSION" \
               --arg c "$COMMIT" --arg i "sha256-$INTEGRITY" --arg t "$TIMESTAMP" \
               'if (.themes | map(.repo) | index($repo)) then
                  .themes = [.themes[] | if .repo == $repo then {repo: $repo, id: $id, version: $v, commit: $c, integrity: $i, locked: $t} else . end]
                else
                  .themes += [{repo: $repo, id: $id, version: $v, commit: $c, integrity: $i, locked: $t}]
                end | .updated = $t' \
               index.lock.json > tmp.json && mv tmp.json index.lock.json

            VENDORED_THEMES="$VENDORED_THEMES$THEME_ID (v$VERSION)\n"

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          # Deduplicate lockfile (keep last occurrence per repo) and format
          jq -S '.themes = (.themes | group_by(.repo) | map(.[-1]))' index.lock.json > tmp.json && mv tmp.json index.lock.json

          echo "vendored<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VENDORED_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate App Token for vendor commit
        id: app-token-vendor
        if: steps.vendor.outputs.vendored != '' || steps.cleanup.outputs.removed != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Commit theme changes
        if: steps.vendor.outputs.vendored != '' || steps.cleanup.outputs.removed != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.app-token-vendor.outputs.token }}
        run: |
          git config user.name "better-lyrics-harmonizer[bot]"
          git config user.email "2418247+better-lyrics-harmonizer[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.event.pull_request.head.repo.full_name }}.git"
          git add themes/ index.lock.json

          # Build commit message
          MSG=""
          if [ -n "${{ steps.vendor.outputs.vendored }}" ]; then
            MSG="chore: vendor new themes"
          fi
          if [ -n "${{ steps.cleanup.outputs.removed }}" ]; then
            if [ -n "$MSG" ]; then
              MSG="$MSG and remove old themes"
            else
              MSG="chore: remove themes"
            fi
          fi

          git commit -m "$MSG"
          git push

      - name: Generate App Token for comments
        id: app-token-comment
        if: steps.new-themes.outputs.themes != '' || steps.cleanup.outputs.removed != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Comment on PR
        if: steps.new-themes.outputs.themes != '' || steps.cleanup.outputs.removed != ''
        uses: actions/github-script@v7
        env:
          DUPLICATE_RESULTS: ${{ steps.check-duplicates.outputs.results }}
          DUPLICATE_ERRORS: ${{ steps.check-duplicates.outputs.has_errors }}
          VALIDATE_RESULTS: ${{ steps.validate.outputs.results }}
          VALIDATE_ERRORS: ${{ steps.validate.outputs.has_errors }}
          VENDORED: ${{ steps.vendor.outputs.vendored }}
          REMOVED: ${{ steps.cleanup.outputs.removed }}
        with:
          github-token: ${{ steps.app-token-comment.outputs.token }}
          script: |
            const duplicateResults = (process.env.DUPLICATE_RESULTS || '').trim();
            const duplicateErrors = process.env.DUPLICATE_ERRORS === 'true';
            const validateResults = (process.env.VALIDATE_RESULTS || '').trim();
            const validateErrors = process.env.VALIDATE_ERRORS === 'true';
            const vendored = (process.env.VENDORED || '').trim();
            const removed = (process.env.REMOVED || '').trim();
            const hasErrors = duplicateErrors || validateErrors;

            let body = '## Theme Changes\n\n';
            if (duplicateResults) body += duplicateResults + '\n\n';
            if (validateResults) body += validateResults + '\n\n';
            if (vendored && !hasErrors) {
              body += '### Added Themes\n\n';
              body += vendored.split('\n').filter(Boolean).map(t => `- ${t}`).join('\n') + '\n\n';
            }
            if (removed) {
              body += '### Removed Themes\n\n';
              body += removed.split('\n').filter(Boolean).map(t => `- ${t}`).join('\n') + '\n\n';
            }
            if (hasErrors) {
              body += 'Please fix the errors above.';
            } else {
              body += 'All checks passed.\n\n';
              body += '---\n\n';
              body += '**Enable auto-updates:** [Install Better Lyrics Harmonizer](https://github.com/apps/better-lyrics-harmonizer/installations/new) on your theme repo to automatically publish future updates when you push.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if errors
        if: steps.check-duplicates.outputs.has_errors == 'true' || steps.validate.outputs.has_errors == 'true'
        run: exit 1

  validate-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Collect existing theme IDs
        id: existing-ids
        run: |
          EXISTING_IDS=""
          if [ -f index.json ] && jq empty index.json 2>/dev/null; then
            while IFS= read -r repo; do
              [ -z "$repo" ] && continue
              git clone --depth 1 "https://github.com/$repo.git" existing-theme 2>/dev/null || continue
              if [ -f "existing-theme/metadata.json" ]; then
                ID=$(jq -r '.id // empty' existing-theme/metadata.json)
                if [ -n "$ID" ]; then
                  EXISTING_IDS="$EXISTING_IDS$ID\n"
                fi
              fi
              rm -rf existing-theme
            done < <(jq -r '.themes[].repo' index.json)
          fi
          echo "ids<<EOF" >> $GITHUB_OUTPUT
          echo -e "$EXISTING_IDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for duplicate theme ID
        run: |
          echo "Checking for duplicate ID: ${{ inputs.theme }}"

          git clone --depth 1 "https://github.com/${{ inputs.theme }}.git" theme-repo

          EXISTING_IDS="${{ steps.existing-ids.outputs.ids }}"

          if [ -f "theme-repo/metadata.json" ]; then
            THEME_ID=$(jq -r '.id // empty' theme-repo/metadata.json)
            if [ -n "$THEME_ID" ] && echo -e "$EXISTING_IDS" | grep -qx "$THEME_ID"; then
              echo "Error: Duplicate theme ID - '$THEME_ID' already exists in another theme."
              exit 1
            fi
            echo "No duplicate ID found for '$THEME_ID'"
          fi

      - name: Validate theme
        run: |
          echo "Validating: ${{ inputs.theme }}"

          npx create-bl-theme@latest validate theme-repo
