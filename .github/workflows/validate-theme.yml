name: Validate Theme

on:
  pull_request_target:
    paths:
      - 'index.json'
  workflow_dispatch:
    inputs:
      theme:
        description: 'Theme repo to validate (e.g. username/theme-name)'
        required: true
        type: string

jobs:
  validate-pr:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Format index.json
        id: format
        run: |
          jq -S . index.json > tmp.json && mv tmp.json index.json
          if git diff --quiet index.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit formatting
        if: steps.format.outputs.changed == 'true'
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.json
          git commit -m "chore: format index.json"
          git push

      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get new themes
        id: new-themes
        run: |
          if [ -f base/index.json ] && jq empty base/index.json 2>/dev/null; then
            jq -r '.themes[].repo' base/index.json | sort > old_themes.txt
          else
            touch old_themes.txt
          fi
          jq -r '.themes[].repo' index.json | sort > new_themes.txt
          NEW_THEMES=$(comm -13 old_themes.txt new_themes.txt)
          echo "themes<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Collect existing theme IDs
        id: existing-ids
        run: |
          EXISTING_IDS=""
          if [ -f base/index.json ] && jq empty base/index.json 2>/dev/null; then
            while IFS= read -r repo; do
              [ -z "$repo" ] && continue
              git clone --depth 1 "https://github.com/$repo.git" existing-theme 2>/dev/null || continue
              if [ -f "existing-theme/metadata.json" ]; then
                ID=$(jq -r '.id // empty' existing-theme/metadata.json)
                if [ -n "$ID" ]; then
                  EXISTING_IDS="$EXISTING_IDS$ID\n"
                fi
              fi
              rm -rf existing-theme
            done < <(jq -r '.themes[].repo' base/index.json)
          fi
          echo "ids<<EOF" >> $GITHUB_OUTPUT
          echo -e "$EXISTING_IDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for duplicate theme IDs
        id: check-duplicates
        if: steps.new-themes.outputs.themes != ''
        run: |
          RESULTS=""
          HAS_ERRORS=false
          EXISTING_IDS="${{ steps.existing-ids.outputs.ids }}"

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Checking for duplicate ID: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null

            if [ ! -d "theme-repo" ]; then
              RESULTS="$RESULTS\n### $repo\nFailed to clone repository\n"
              HAS_ERRORS=true
              continue
            fi

            if [ -f "theme-repo/metadata.json" ]; then
              THEME_ID=$(jq -r '.id // empty' theme-repo/metadata.json)
              if [ -n "$THEME_ID" ] && echo -e "$EXISTING_IDS" | grep -qx "$THEME_ID"; then
                RESULTS="$RESULTS\n### $repo\n**Error: Duplicate theme ID** - \`$THEME_ID\` already exists in another theme.\n"
                HAS_ERRORS=true
              fi
            fi

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT

      - name: Validate themes
        id: validate
        if: steps.new-themes.outputs.themes != '' && steps.check-duplicates.outputs.has_errors != 'true'
        run: |
          RESULTS=""
          HAS_ERRORS=false

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Validating: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null

            if [ ! -d "theme-repo" ]; then
              RESULTS="$RESULTS\n### $repo\nFailed to clone repository\n"
              HAS_ERRORS=true
              continue
            fi

            OUTPUT=$(npx create-bl-theme@latest validate theme-repo 2>&1) || HAS_ERRORS=true
            RESULTS="$RESULTS\n### $repo\n\`\`\`\n$OUTPUT\n\`\`\`\n"

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT

      - name: Vendor new themes
        id: vendor
        if: steps.new-themes.outputs.themes != '' && steps.check-duplicates.outputs.has_errors != 'true' && steps.validate.outputs.has_errors != 'true'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          VENDORED_THEMES=""

          # Initialize lockfile if it doesn't exist
          if [ ! -f index.lock.json ]; then
            echo '{"version":1,"updated":"'"$TIMESTAMP"'","themes":[]}' > index.lock.json
          fi

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Vendoring: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null
            if [ ! -d "theme-repo" ]; then
              echo "Failed to clone $repo"
              continue
            fi

            cd theme-repo
            COMMIT=$(git rev-parse HEAD)
            cd ..

            THEME_ID=$(jq -r '.id' theme-repo/metadata.json)
            VERSION=$(jq -r '.version' theme-repo/metadata.json)

            # Create vendor directory
            mkdir -p "themes/$THEME_ID"

            # Copy essential files
            cp theme-repo/metadata.json "themes/$THEME_ID/"
            [ -f theme-repo/style.rics ] && cp theme-repo/style.rics "themes/$THEME_ID/"
            [ -f theme-repo/style.css ] && cp theme-repo/style.css "themes/$THEME_ID/"
            [ -f theme-repo/shader.json ] && cp theme-repo/shader.json "themes/$THEME_ID/"
            [ -f theme-repo/DESCRIPTION.md ] && cp theme-repo/DESCRIPTION.md "themes/$THEME_ID/"
            [ -f theme-repo/cover.png ] && cp theme-repo/cover.png "themes/$THEME_ID/"
            [ -d theme-repo/images ] && cp -r theme-repo/images "themes/$THEME_ID/"

            # Calculate integrity hash
            INTEGRITY=$(find "themes/$THEME_ID" -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)

            # Add to lockfile
            jq --arg repo "$repo" --arg id "$THEME_ID" --arg v "$VERSION" \
               --arg c "$COMMIT" --arg i "sha256-$INTEGRITY" --arg t "$TIMESTAMP" \
               '.themes += [{repo: $repo, id: $id, version: $v, commit: $c, integrity: $i, locked: $t}] | .updated = $t' \
               index.lock.json > tmp.json && mv tmp.json index.lock.json

            VENDORED_THEMES="$VENDORED_THEMES$THEME_ID (v$VERSION)\n"

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          # Format lockfile
          jq -S . index.lock.json > tmp.json && mv tmp.json index.lock.json

          echo "vendored<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VENDORED_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit vendored themes
        if: steps.vendor.outputs.vendored != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add themes/ index.lock.json
          git commit -m "chore: vendor new themes"
          git push

      - name: Generate App Token
        id: app-token
        if: steps.new-themes.outputs.themes != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Comment on PR
        if: steps.new-themes.outputs.themes != ''
        uses: actions/github-script@v7
        env:
          DUPLICATE_RESULTS: ${{ steps.check-duplicates.outputs.results }}
          DUPLICATE_ERRORS: ${{ steps.check-duplicates.outputs.has_errors }}
          VALIDATE_RESULTS: ${{ steps.validate.outputs.results }}
          VALIDATE_ERRORS: ${{ steps.validate.outputs.has_errors }}
          VENDORED: ${{ steps.vendor.outputs.vendored }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const duplicateResults = (process.env.DUPLICATE_RESULTS || '').trim();
            const duplicateErrors = process.env.DUPLICATE_ERRORS === 'true';
            const validateResults = (process.env.VALIDATE_RESULTS || '').trim();
            const validateErrors = process.env.VALIDATE_ERRORS === 'true';
            const vendored = (process.env.VENDORED || '').trim();
            const hasErrors = duplicateErrors || validateErrors;

            let body = '## Theme Validation Results\n\n';
            if (duplicateResults) body += duplicateResults + '\n\n';
            if (validateResults) body += validateResults + '\n\n';
            if (vendored && !hasErrors) {
              body += '### Vendored Themes\n\n';
              body += vendored.split('\n').filter(Boolean).map(t => `- ${t}`).join('\n') + '\n\n';
            }
            body += hasErrors ? 'Please fix the errors above.' : 'All checks passed.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if errors
        if: steps.check-duplicates.outputs.has_errors == 'true' || steps.validate.outputs.has_errors == 'true'
        run: exit 1

  validate-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Collect existing theme IDs
        id: existing-ids
        run: |
          EXISTING_IDS=""
          if [ -f index.json ] && jq empty index.json 2>/dev/null; then
            while IFS= read -r repo; do
              [ -z "$repo" ] && continue
              git clone --depth 1 "https://github.com/$repo.git" existing-theme 2>/dev/null || continue
              if [ -f "existing-theme/metadata.json" ]; then
                ID=$(jq -r '.id // empty' existing-theme/metadata.json)
                if [ -n "$ID" ]; then
                  EXISTING_IDS="$EXISTING_IDS$ID\n"
                fi
              fi
              rm -rf existing-theme
            done < <(jq -r '.themes[].repo' index.json)
          fi
          echo "ids<<EOF" >> $GITHUB_OUTPUT
          echo -e "$EXISTING_IDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for duplicate theme ID
        run: |
          echo "Checking for duplicate ID: ${{ inputs.theme }}"

          git clone --depth 1 "https://github.com/${{ inputs.theme }}.git" theme-repo

          EXISTING_IDS="${{ steps.existing-ids.outputs.ids }}"

          if [ -f "theme-repo/metadata.json" ]; then
            THEME_ID=$(jq -r '.id // empty' theme-repo/metadata.json)
            if [ -n "$THEME_ID" ] && echo -e "$EXISTING_IDS" | grep -qx "$THEME_ID"; then
              echo "Error: Duplicate theme ID - '$THEME_ID' already exists in another theme."
              exit 1
            fi
            echo "No duplicate ID found for '$THEME_ID'"
          fi

      - name: Validate theme
        run: |
          echo "Validating: ${{ inputs.theme }}"

          npx create-bl-theme@latest validate theme-repo
