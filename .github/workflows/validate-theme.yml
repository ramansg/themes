name: Validate Theme

on:
  pull_request:
    paths:
      - 'index.json'
  workflow_dispatch:
    inputs:
      theme:
        description: 'Theme repo to validate (e.g. username/theme-name)'
        required: true
        type: string

jobs:
  validate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get new themes
        id: new-themes
        run: |
          if [ -f base/index.json ] && jq empty base/index.json 2>/dev/null; then
            jq -r '.themes[].repo' base/index.json | sort > old_themes.txt
          else
            touch old_themes.txt
          fi
          jq -r '.themes[].repo' index.json | sort > new_themes.txt
          NEW_THEMES=$(comm -13 old_themes.txt new_themes.txt)
          echo "themes<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_THEMES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate themes
        id: validate
        if: steps.new-themes.outputs.themes != ''
        run: |
          RESULTS=""
          HAS_ERRORS=false

          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            echo "Validating: $repo"

            git clone --depth 1 "https://github.com/$repo.git" theme-repo 2>/dev/null

            if [ ! -d "theme-repo" ]; then
              RESULTS="$RESULTS\n### $repo\nFailed to clone repository\n"
              HAS_ERRORS=true
              continue
            fi

            OUTPUT=$(npx create-bl-theme@latest validate theme-repo 2>&1) || HAS_ERRORS=true
            RESULTS="$RESULTS\n### $repo\n\`\`\`\n$OUTPUT\n\`\`\`\n"

            rm -rf theme-repo
          done <<< "${{ steps.new-themes.outputs.themes }}"

          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.new-themes.outputs.themes != ''
        uses: actions/github-script@v7
        env:
          RESULTS: ${{ steps.validate.outputs.results }}
          HAS_ERRORS: ${{ steps.validate.outputs.has_errors }}
        with:
          script: |
            const results = process.env.RESULTS.trim();
            const hasErrors = process.env.HAS_ERRORS === 'true';

            let body = '## Theme Validation Results\n\n';
            body += results + '\n\n';
            body += hasErrors ? 'Please fix the errors above.' : 'All checks passed.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail if errors
        if: steps.validate.outputs.has_errors == 'true'
        run: exit 1

  validate-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate theme
        run: |
          echo "Validating: ${{ inputs.theme }}"

          git clone --depth 1 "https://github.com/${{ inputs.theme }}.git" theme-repo

          npx create-bl-theme@latest validate theme-repo
